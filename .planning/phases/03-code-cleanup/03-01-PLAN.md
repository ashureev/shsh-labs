---
phase: 03-code-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/store/sqlite.go
  - internal/container/ttl.go
  - internal/api/container.go
  - internal/shared/sqlite_errors.go
autonomous: true
requirements:
  - CLEAN-02
must_haves:
  truths:
    - SQLite error checking uses shared helper functions
    - No duplicate error string matching patterns exist
    - All SQLite error checks are consistent across codebase
  artifacts:
    - path: internal/shared/sqlite_errors.go
      provides: Shared SQLite error checking utilities
      exports: ["IsSQLiteBusyError", "IsSQLiteLockedError"]
    - path: internal/store/sqlite.go
      provides: Uses shared error helpers
      pattern: "shared\\.IsSQLite"
    - path: internal/container/ttl.go
      provides: Uses shared error helpers
      pattern: "shared\\.IsSQLite"
    - path: internal/api/container.go
      provides: Uses shared error helpers
      pattern: "shared\\.IsSQLite"
  key_links:
    - from: internal/shared/sqlite_errors.go
      to: internal/store/sqlite.go
      via: import
      pattern: 'import.*shared'
    - from: internal/shared/sqlite_errors.go
      to: internal/container/ttl.go
      via: import
      pattern: 'import.*shared'
    - from: internal/shared/sqlite_errors.go
      to: internal/api/container.go
      via: import
      pattern: 'import.*shared'
---

<objective>
Consolidate duplicate SQLite error checking patterns into shared helper functions.

Purpose: Eliminate code duplication and ensure consistent SQLite error handling across the codebase.
Output: New shared package with SQLite error utilities, updated files using the shared helpers.
</objective>

<execution_context>
@/home/ashu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ashu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@/home/ashu/Downloads/mycodes/shsh-labs/internal/store/sqlite.go
@/home/ashu/Downloads/mycodes/shsh-labs/internal/container/ttl.go
@/home/ashu/Downloads/mycodes/shsh-labs/internal/api/container.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared SQLite error utilities</name>
  <files>internal/shared/sqlite_errors.go</files>
  <action>
    Create a new shared package file at internal/shared/sqlite_errors.go that exports:
    - IsSQLiteBusyError(err error) bool - checks for "SQLITE_BUSY" in error string
    - IsSQLiteLockedError(err error) bool - checks for "database is locked" in error string
    - IsSQLiteConflictError(err error) bool - checks for either busy or locked errors

    Use strings.Contains for error string checking. Add proper package documentation.
    The shared package should be importable from store, container, and api packages.
  </action>
  <verify>go build ./internal/shared/... succeeds without errors</verify>
  <done>File internal/shared/sqlite_errors.go exists with three exported functions and package documentation</done>
</task>

<task type="auto">
  <name>Task 2: Update sqlite.go to use shared helpers</name>
  <files>internal/store/sqlite.go</files>
  <action>
    Replace the inline error string checking in DeleteAgentSession function with calls to shared helpers.

    Current code (around line 355):
    ```go
    if strings.Contains(err.Error(), "database is locked") || strings.Contains(err.Error(), "SQLITE_BUSY") {
    ```

    Replace with:
    ```go
    if shared.IsSQLiteConflictError(err) {
    ```

    Add import for the shared package. Remove "strings" import if no longer needed.
  </action>
  <verify>go build ./internal/store/... succeeds without errors</verify>
  <done>sqlite.go uses shared.IsSQLiteConflictError instead of inline string checking</done>
</task>

<task type="auto">
  <name>Task 3: Update ttl.go to use shared helpers</name>
  <files>internal/container/ttl.go</files>
  <action>
    Replace inline error string checking in both deleteAgentSessionWithRetry and updateContainerIDWithRetry functions.

    Current patterns:
    - Line 33: strings.Contains(err.Error(), "database is locked") || strings.Contains(err.Error(), "SQLITE_BUSY")
    - Line 71: strings.Contains(errStr, "database is locked") || strings.Contains(errStr, "SQLITE_BUSY")

    Replace both with shared.IsSQLiteConflictError(err) or shared.IsSQLiteLockedError/IsSQLiteBusyError as appropriate.

    Add import for shared package. Remove "strings" import if no longer needed.
  </action>
  <verify>go build ./internal/container/... succeeds without errors</verify>
  <done>ttl.go uses shared helper functions instead of inline string checking</done>
</task>

<task type="auto">
  <name>Task 4: Update container.go to use shared helpers</name>
  <files>internal/api/container.go</files>
  <action>
    Replace inline error string checking in updateContainerIDWithRetry function (around line 219).

    Current code:
    ```go
    if strings.Contains(errStr, "database is locked") || strings.Contains(errStr, "SQLITE_BUSY") {
    ```

    Replace with shared helper call. Add import for shared package. Remove "strings" import if no longer needed.
  </action>
  <verify>go build ./internal/api/... succeeds without errors</verify>
  <done>container.go uses shared helper functions instead of inline string checking</done>
</task>

</tasks>

<verification>
Run golangci-lint to verify no regressions:
```bash
golangci-lint run ./...
```

Run tests to ensure no breakage:
```bash
go test ./internal/store/... ./internal/container/... ./internal/api/...
```

Verify shared package is importable:
```bash
go build ./internal/shared/...
```
</verification>

<success_criteria>
- internal/shared/sqlite_errors.go exists with IsSQLiteBusyError, IsSQLiteLockedError, IsSQLiteConflictError
- All three files (sqlite.go, ttl.go, container.go) import and use shared helpers
- No duplicate strings.Contains patterns for SQLite errors remain
- All builds pass: go build ./...
- All tests pass: go test ./...
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-cleanup/03-01-SUMMARY.md`
</output>
