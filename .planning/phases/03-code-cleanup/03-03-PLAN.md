---
phase: 03-code-cleanup
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/store/sqlite.go
  - internal/terminal/manager.go
  - internal/terminal/circular_buffer.go
  - internal/terminal/async_dual_writer.go
autonomous: true
requirements:
  - CLEAN-03
must_haves:
  truths:
    - All mutex unlocks use defer pattern consistently
    - No manual Unlock() calls that could be deferred
    - All RLock/RUnlock pairs use defer
  artifacts:
    - path: internal/store/sqlite.go
      provides: SQLite store with consistent mutex patterns
      pattern: "defer.*agentSessionMu\\.Unlock"
    - path: internal/terminal/manager.go
      provides: Session manager with consistent mutex patterns
      pattern: "defer.*mu\\.Unlock"
    - path: internal/terminal/circular_buffer.go
      provides: Circular buffer with consistent mutex patterns
      pattern: "defer.*mu\\.Unlock"
    - path: internal/terminal/async_dual_writer.go
      provides: Async writer with consistent mutex patterns
      pattern: "defer.*mu\\.Unlock"
  key_links:
    - from: internal/store/sqlite.go
      to: internal/store/sqlite.go
      via: "defer unlock pattern"
      pattern: "defer.*Unlock"
---

<objective>
Verify and standardize mutex unlock patterns to use defer consistently.

Purpose: Ensure all mutex unlocks follow the defer pattern for safety and consistency.
Output: All mutex operations use defer for unlocks (except where excluded).
</objective>

<execution_context>
@/home/ashu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ashu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@/home/ashu/Downloads/mycodes/shsh-labs/internal/store/sqlite.go
@/home/ashu/Downloads/mycodes/shsh-labs/internal/terminal/manager.go
@/home/ashu/Downloads/mycodes/shsh-labs/internal/terminal/circular_buffer.go
@/home/ashu/Downloads/mycodes/shsh-labs/internal/terminal/async_dual_writer.go

**EXCLUDED:** internal/terminal/monitor.go is explicitly excluded from this phase per ROADMAP.md due to complex mutex hierarchy.
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit mutex patterns in sqlite.go</name>
  <files>internal/store/sqlite.go</files>
  <action>
    Review all mutex usage in sqlite.go. The file uses agentSessionMu for protecting agent session operations.

    Current patterns found:
    - Line 257-258: GetAgentSession uses `defer s.agentSessionMu.Unlock()` - CORRECT
    - Line 303-304: UpsertAgentSession uses `defer s.agentSessionMu.Unlock()` - CORRECT
    - Line 376-377: deleteAgentSessionOnce uses `defer s.agentSessionMu.Unlock()` - CORRECT
    - Line 400-401: DeleteLegacyLocalState uses `defer s.agentSessionMu.Unlock()` - CORRECT

    Verify all Lock() calls have matching defer Unlock(). If any manual Unlock() exists without defer, convert it.
  </action>
  <verify>grep -n "agentSessionMu" internal/store/sqlite.go | head -30</verify>
  <done>All agentSessionMu.Lock() calls have matching defer agentSessionMu.Unlock()</done>
</task>

<task type="auto">
  <name>Task 2: Audit mutex patterns in terminal/manager.go</name>
  <files>internal/terminal/manager.go</files>
  <action>
    Review all mutex usage in terminal/manager.go. The file uses sync.RWMutex for session management.

    Current patterns found:
    - Line 26-27: GetActive uses `defer m.mu.RUnlock()` - CORRECT
    - Line 36-37: Register uses `defer m.mu.Unlock()` - CORRECT
    - Line 53-54: Unregister uses `defer m.mu.Unlock()` - CORRECT
    - Line 69-70: CloseSession uses `defer m.mu.Unlock()` - CORRECT

    Verify all Lock/RLock calls have matching defer Unlock/RUnlock. Check if any manual unlocks exist.
  </action>
  <verify>grep -n "mu\.\(Lock\|Unlock\|RLock\|RUnlock\)" internal/terminal/manager.go</verify>
  <done>All mu.Lock/RLock calls have matching defer Unlock/RUnlock</done>
</task>

<task type="auto">
  <name>Task 3: Audit mutex patterns in circular_buffer.go</name>
  <files>internal/terminal/circular_buffer.go</files>
  <action>
    Review all mutex usage in circular_buffer.go. The file uses sync.RWMutex.

    Current patterns found:
    - Line 33-34: Write uses `defer cb.mu.Unlock()` - CORRECT
    - Line 53-54: String uses `defer cb.mu.RUnlock()` - CORRECT
    - Line 76-77: Bytes uses `defer cb.mu.RUnlock()` - CORRECT
    - Line 105-106: Len uses `defer cb.mu.RUnlock()` - CORRECT
    - Line 125-126: Reset uses `defer cb.mu.Unlock()` - CORRECT

    All patterns already use defer correctly.
  </action>
  <verify>grep -n "mu\.\(Lock\|Unlock\|RLock\|RUnlock\)" internal/terminal/circular_buffer.go</verify>
  <done>All mutex operations use defer pattern correctly</done>
</task>

<task type="auto">
  <name>Task 4: Audit mutex patterns in async_dual_writer.go</name>
  <files>internal/terminal/async_dual_writer.go</files>
  <action>
    Review all mutex usage in async_dual_writer.go. Check if there are any Lock/Unlock patterns.

    The file uses sync.WaitGroup but may not use explicit mutex. Check for any sync.Mutex usage.
  </action>
  <verify>grep -n "mu\.\|sync\.Mutex\|sync\.RWMutex" internal/terminal/async_dual_writer.go</verify>
  <done>File verified - uses sync.WaitGroup appropriately, no mutex issues</done>
</task>

<task type="auto">
  <name>Task 5: Document mutex pattern compliance</name>
  <files>CONVENTIONS.md (if exists) or create note</files>
  <action>
    Document the mutex pattern standard for future reference. Create a brief note in the codebase or verify CONVENTIONS.md exists with the mutex pattern rule.

    The pattern is:
    ```go
    m.mu.Lock()
    defer m.mu.Unlock()
    // ... critical section ...
    ```

    NOT:
    ```go
    m.mu.Lock()
    // ... critical section ...
    m.mu.Unlock()  // manual - avoid
    ```

    Exception: internal/terminal/monitor.go has complex nested mutex patterns that are excluded.
  </action>
  <verify>Check if CONVENTIONS.md exists and update with mutex pattern guidance</verify>
  <done>Mutex pattern standard documented or verified in conventions</done>
</task>

</tasks>

<verification>
Run grep to verify no manual unlocks exist (excluding monitor.go and test files):
```bash
grep -rn "\.Unlock()" --include="*.go" . | grep -v "defer" | grep -v "_test.go" | grep -v "monitor.go"
```

This should return no results or only results from excluded files.

Run tests:
```bash
go test ./internal/store/... ./internal/terminal/...
```
</verification>

<success_criteria>
- All mutex Lock/RLock calls have matching defer Unlock/RUnlock (except monitor.go)
- No manual Unlock() calls exist outside of defer patterns (except monitor.go)
- All tests pass: go test ./internal/store/... ./internal/terminal/...
- grep for manual unlocks returns only monitor.go or test files
</success_criteria>

<output>
After completion, create `.planning/phases/03-code-cleanup/03-03-SUMMARY.md`
</output>
